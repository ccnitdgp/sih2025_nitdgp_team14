
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // Helpers
    // ============================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function hasRole(role) {
      return isSignedIn()
        && userDoc(request.auth.uid).data.role == role;
    }

    function isPatient() { return hasRole("patient"); }
    function isDoctor()  { return hasRole("doctor"); }
    function isAdmin()   { return hasRole("admin"); }

    // Efficiently checks if the requesting doctor is assigned to the patient.
    // This performs a single document read.
    function isDoctorAssignedToPatient(patientId) {
      let patientDoc = get(/databases/$(database)/documents/users/$(patientId));
      return isDoctor() && patientDoc.data.doctorId == request.auth.uid;
    }

    // ============================================================
    // /users/{userId}  (UserProfile - private)
    // ============================================================

    match /users/{userId} {

      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.id == userId;

      // User can always read/update their own profile.
      // An assigned doctor can also read a patient's profile.
      allow get: if isSignedIn() && (isOwner(userId) || isDoctorAssignedToPatient(userId));
      
      // Only the user can update their own profile.
      allow update: if isSignedIn() && isOwner(userId);


      // Admins can list all users.
      allow list: if isAdmin();
      allow delete: if isAdmin();


      // ----------------------------------------------
      // /users/{userId}/healthRecords/{healthRecordId}
      // ----------------------------------------------
      match /healthRecords/{healthRecordId} {

        function newRecordUserMatchesPath() {
          return request.resource.data.userId == userId;
        }

        function existingRecordUserMatchesPath() {
          return resource.data.userId == userId;
        }

        // Create: patient themself, assigned doctor, or admin.
        allow create: if isSignedIn()
          && newRecordUserMatchesPath()
          && (
            isOwner(userId) ||
            isDoctorAssignedToPatient(userId) ||
            isAdmin()
          );

        // Read/list/update/delete: patient owner, assigned doctor, or admin.
        allow get, list, update, delete: if isSignedIn()
          && existingRecordUserMatchesPath()
          && (
            isOwner(userId) ||
            isDoctorAssignedToPatient(userId) ||
            isAdmin()
          );
      }


      // ----------------------------------------------
      // /users/{userId}/notifications/{notificationId}
      // ----------------------------------------------
      match /notifications/{notificationId} {

        // Only the owner (or admin) can manage their notifications.
        allow create, get, list, update, delete: if isSignedIn()
          && (isOwner(userId) || isAdmin());
      }
    }


    // ============================================================
    // /doctors/{doctorId}  (DoctorProfile - public)
    // ============================================================
    match /doctors/{doctorId} {
        allow get, list: if true;
        allow create: if isOwner(doctorId);
        allow update: if isSignedIn() && (
            isAdmin() || 
            (isOwner(doctorId) && !('isVerified' in request.resource.data) && !('verificationNote' in request.resource.data))
        );
    }
    

    // ============================================================
    // /appointments/{appointmentId} (Appointment)
    // ============================================================
    match /appointments/{appointmentId} {

        function isPatientForAppointment(doc) {
            return isSignedIn() && request.auth.uid == doc.patientId;
        }
        
        function isDoctorForAppointment(doc) {
            return isSignedIn() && request.auth.uid == doc.doctorId;
        }

        allow create: if isPatientForAppointment(request.resource.data);
        
        allow get: if isSignedIn() && (
            isOwner(resource.data.patientId) || 
            isOwner(resource.data.doctorId) || 
            isAdmin()
        );

        allow update: if isSignedIn() && (
            isAdmin() ||
            (isOwner(resource.data.patientId) && request.resource.data.status == 'Canceled' && resource.data.status == 'Scheduled') ||
            (isOwner(resource.data.doctorId))
        );

        allow list: if isSignedIn() && (
          (request.query.where.doctorId == request.auth.uid && isDoctor()) ||
          (request.query.where.patientId == request.auth.uid && isPatient()) ||
          isAdmin()
        );

        allow delete: if isAdmin();
    }
    
    // ============================================================
    // /prescriptions/{prescriptionId} (Prescription)
    // ============================================================
    match /prescriptions/{prescriptionId} {
      allow get: if isSignedIn() && (resource.data.patientId == request.auth.uid || resource.data.doctorId == request.auth.uid || isAdmin());
      
      allow list: if isSignedIn() && (
        (request.query.where.doctorId == request.auth.uid && isDoctor()) ||
        (request.query.where.patientId == request.auth.uid && isPatient()) ||
        isAdmin()
      );

      allow create: if isSignedIn() && isDoctor() && request.resource.data.doctorId == request.auth.uid;

      allow update, delete: if isSignedIn() && (isOwner(resource.data.doctorId) || isAdmin());
    }


    // ============================================================
    // Public Collections
    // ============================================================
    match /vaccinationDrives/{docId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

     match /healthCamps/{docId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }
    
    match /announcements/{docId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }


    // ============================================================
    // User-Specific Write Collections
    // ============================================================
    match /vaccinationRegistrations/{registrationId} {
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow get: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin());
        allow list: if isSignedIn() && (request.query.where.userId == request.auth.uid || isAdmin());
        allow delete, update: if isAdmin();
    }
    
     match /feedback/{feedbackId} {
        allow create: if isSignedIn();
        allow list: if (request.query.where.rating >= 4 && request.query.where.feedbackType == 'General Feedback') || isAdmin();
        allow get, update, delete: if isAdmin();
    }

    // ============================================================
    // Forum
    // ============================================================
     match /forumPosts/{postId} {
        allow create: if isSignedIn();
        allow get, list: if true;
        allow update: if isSignedIn() &&
          (
            (isOwner(resource.data.authorId) || isAdmin()) ||
            (
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount', 'likedBy']) &&
              (
                (
                  request.resource.data.likeCount == resource.data.likeCount + 1 &&
                  request.resource.data.likedBy.hasAll(resource.data.likedBy) &&
                  request.resource.data.likedBy.size() == resource.data.likedBy.size() + 1 &&
                  request.auth.uid in request.resource.data.likedBy
                ) || 
                (
                  request.resource.data.likeCount == resource.data.likeCount - 1 &&
                  !request.resource.data.likedBy.hasAny([request.auth.uid]) &&
                  request.auth.uid in resource.data.likedBy
                )
              )
            ) ||
            (
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']) &&
                request.resource.data.viewCount == resource.data.viewCount + 1
            )
          );
        
        allow delete: if isSignedIn() && (isOwner(resource.data.authorId) || isAdmin());
        
        match /replies/{replyId} {
            allow create: if isSignedIn();
            allow get, list: if true;
            allow update, delete: if isSignedIn() && (isOwner(resource.data.authorId) || isAdmin());
        }
     }
  }
}
