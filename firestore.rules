
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // Helpers
    // ============================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Load current user's profile
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function hasRole(role) {
      return isSignedIn()
        && userDoc(request.auth.uid).data.role == role;
    }

    function isPatient() { return hasRole("patient"); }
    function isDoctor()  { return hasRole("doctor"); }
    function isAdmin()   { return hasRole("admin"); }

    // Is the current doctor linked to this patient via PatientLink?
    function isAssignedDoctorForUser(userId) {
      return isDoctor()
        && exists(
          /databases/$(database)/documents/users/$(request.auth.uid)/patients/$(userId)
        );
    }

    // ============================================================
    // /users/{userId}  (UserProfile - private)
    // ============================================================

    match /users/{userId} {

      // Create own profile: id field must match auth.uid & path.
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.id == userId;

      // User reads/updates their own profile.
      allow get, update: if isOwner(userId);

      // Only admins can list or delete user profiles.
      allow list, delete: if isAdmin();


      // ----------------------------------------------
      // /users/{userId}/healthRecords/{healthRecordId}
      // ----------------------------------------------
      match /healthRecords/{healthRecordId} {

        // For new docs, userId field must match path.
        function newRecordUserMatchesPath() {
          return request.resource.data.userId == userId;
        }

        // For existing docs, userId field must match path.
        function existingRecordUserMatchesPath() {
          return resource.data.userId == userId;
        }

        // Create: patient themself, assigned doctor, or admin.
        allow create: if isSignedIn()
          && newRecordUserMatchesPath()
          && (
            isOwner(userId) ||
            isAssignedDoctorForUser(userId) ||
            isAdmin()
          );

        // Read/list/update/delete:
        // - patient owner
        // - assigned doctor (via PatientLink)
        // - admin
        allow get, list, update, delete: if isSignedIn()
          && existingRecordUserMatchesPath()
          && (
            isOwner(userId) ||
            isAssignedDoctorForUser(userId) ||
            isAdmin()
          );
      }


      // ----------------------------------------------
      // /users/{userId}/notifications/{notificationId}
      // ----------------------------------------------
      match /notifications/{notificationId} {

        // Only the owner (or admin) can manage their notifications.
        allow create, get, list, update, delete: if isSignedIn()
          && (isOwner(userId) || isAdmin());
      }


      // ----------------------------------------------
      // /users/{doctorId}/patients/{patientId} (PatientLink)
      // ----------------------------------------------
      match /patients/{patientId} {

        // Only the doctor who owns this /users/{doctorId} doc
        // or an admin can manage these links.
        allow create, get, list, update, delete: if isSignedIn()
          && (
            (isOwner(userId) && isDoctor()) ||
            isAdmin()
          );
      }
    }


    // ============================================================
    // /doctors/{doctorId}  (DoctorProfile - public)
    // ============================================================
    match /doctors/{doctorId} {
        // Anyone can view a doctor's public profile.
        allow get, list: if true;
        
        // Only the doctor themselves or an admin can create/update.
        allow create, update: if isSignedIn()
          && (isOwner(doctorId) || isAdmin());
    }
    

    // ============================================================
    // /appointments/{appointmentId} (Appointment)
    // ============================================================
    match /appointments/{appointmentId} {

        function isPatientForAppointment() {
            return isSignedIn() && request.auth.uid == request.resource.data.patientId;
        }
        
        function isDoctorForAppointment() {
            return isSignedIn() && request.auth.uid == request.resource.data.doctorId;
        }

        // Create: only patients can create appointments for themselves.
        allow create: if isPatientForAppointment();
        
        // Read/Update: only the involved patient, doctor, or an admin.
        allow get, update: if isSignedIn() && (
            isOwner(resource.data.patientId) || 
            isOwner(resource.data.doctorId) || 
            isAdmin()
        );

        // List/Delete: only admins for now.
        allow list, delete: if isAdmin();
    }
    
    // ============================================================
    // /prescriptions/{prescriptionId} (Prescription)
    // ============================================================
    match /prescriptions/{prescriptionId} {
        function isDoctorForNewPrescription() {
          return isDoctor() && request.auth.uid == request.resource.data.doctorId;
        }
        
        // Create: Only a doctor can create a prescription for a patient.
        allow create: if isDoctorForNewPrescription();
        
        // Read: The involved patient or doctor, or an admin.
        allow get: if isSignedIn() && (
            isOwner(resource.data.patientId) || 
            isOwner(resource.data.doctorId) ||
            isAdmin()
        );
        
        // List: Allow a logged-in doctor to list prescriptions but ONLY if
        // their query is constrained to their own doctorId.
        allow list: if isSignedIn() &&
          (
            (isDoctor() && request.query.where.doctorId == request.auth.uid) ||
            isAdmin()
          );

        // Update/Delete: Only the prescribing doctor.
        allow update, delete: if isOwner(resource.data.doctorId) || isAdmin();
    }


    // ============================================================
    // /vaccinationDrives/{vaccinationDriveId} (public)
    // ============================================================
    match /vaccinationDrives/{vaccinationDriveId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }


    // ============================================================
    // /healthCamps/{healthCampId} (public)
    // ============================================================
    match /healthCamps/{healthCampId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    // ============================================================
    // /forumPosts/{postId} (ForumPost)
    // ============================================================
     match /forumPosts/{postId} {
        // Any signed-in user can create a post.
        allow create: if isSignedIn();

        // Anyone can read posts.
        allow get, list: if true;

        // Only the author or an admin can update/delete their own post.
        // This is a simplified version. Let's separate like/view updates.
        allow update: if isSignedIn() && 
          (
            (isOwner(resource.data.authorId) || isAdmin()) ||
            (
              // Allow anyone to increment like/view counts and add to likedBy
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount', 'viewCount', 'likedBy']) &&
              request.resource.data.likeCount == resource.data.likeCount + 1 &&
              request.resource.data.likedBy.hasAll(resource.data.likedBy) &&
              request.resource.data.likedBy.size() == resource.data.likedBy.size() + 1
            ) ||
            (
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']) &&
                request.resource.data.viewCount == resource.data.viewCount + 1
            )
          );
        
        allow delete: if isSignedIn() && (isOwner(resource.data.authorId) || isAdmin());
        
        // --- /forumPosts/{postId}/replies/{replyId} ---
        match /replies/{replyId} {
             // Any signed-in user can create a reply.
            allow create: if isSignedIn();

            // Anyone can read replies.
            allow get, list: if true;

            // Only the author or an admin can update/delete their own reply.
            allow update, delete: if isSignedIn() && (isOwner(resource.data.authorId) || isAdmin());
        }
     }
     
     
    // ============================================================
    // /feedback/{feedbackId} (Feedback)
    // ============================================================
    match /feedback/{feedbackId} {
        // Any signed-in user can create feedback.
        allow create: if isSignedIn();

        // Only admins can read, update, or delete feedback.
        allow get, list, update, delete: if isAdmin();
    }
  }
}
