
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // Helpers
    // ============================================================

    function isSignedIn() {
      return request.auth != null;
    }

    // Simplified to directly check the uid.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Load current user's profile
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function hasRole(role) {
      // This check still requires reading the user doc, which is fine for rules on OTHER documents.
      return isSignedIn()
        && userDoc(request.auth.uid).data.role == role;
    }

    function isPatient() { return hasRole("patient"); }
    function isDoctor()  { return hasRole("doctor"); }
    function isAdmin()   { return hasRole("admin"); }

    // Is the current doctor the assigned doctor for the patient?
    // This is the most efficient check, performing only one `get`.
    function isDoctorAssignedToPatient(patientId) {
      let patientDoc = get(/databases/$(database)/documents/users/$(patientId));
      return isDoctor() && patientDoc.data.doctorId == request.auth.uid;
    }

    // ============================================================
    // /users/{userId}  (UserProfile - private)
    // ============================================================

    match /users/{userId} {

      // Create own profile: id field must match auth.uid & path.
      // A doctor can create a profile for a patient.
      // TEMP: Allow anyone to create a user profile for development
      allow create: if true;

      // User can always read/update their own profile.
      // An assigned doctor can also read a patient's profile.
      // An Admin can read any user profile
      allow get: if isSignedIn() && (isOwner(userId) || isDoctorAssignedToPatient(userId) || isAdmin());
      
      // Only the user can update their own profile. A doctor can update a patient's profile they are assigned to.
      // A doctor can also become the assigned doctor if one isn't set.
      allow update: if isSignedIn() && (
        isOwner(userId) || 
        isDoctorAssignedToPatient(userId) ||
        (isDoctor() && request.resource.data.doctorId == request.auth.uid && resource.data.doctorId == null)
      );


      // Public can query for patient count. Admins can list all users.
      // Doctors can list patients assigned to them.
      allow list: if (request.query.where.role == 'patient') || isAdmin() || (isDoctor() && request.query.where.doctorId == request.auth.uid);
      allow delete: if isAdmin();


      // ----------------------------------------------
      // /users/{userId}/healthRecords/{healthRecordId}
      // ----------------------------------------------
      match /healthRecords/{healthRecordId} {

        // Create: patient themself, assigned doctor, or admin.
        allow create: if isSignedIn() && (
            isOwner(userId) ||
            isDoctorAssignedToPatient(userId) ||
            isAdmin()
          );
          
        // Read/list/update/delete:
        // - patient owner
        // - assigned doctor (via patient's doctorId field)
        // - admin
        allow get, list, update, delete: if isSignedIn()
          && (
            isOwner(userId) ||
            isDoctorAssignedToPatient(userId) ||
            isAdmin()
          );
      }


      // ----------------------------------------------
      // /users/{userId}/notifications/{notificationId}
      // ----------------------------------------------
      match /notifications/{notificationId} {

        // Only the owner (or admin) can manage their notifications.
        allow create, get, list, update, delete: if isSignedIn()
          && (isOwner(userId) || isAdmin());
      }
    }


    // ============================================================
    // /doctors/{doctorId}  (DoctorProfile - public)
    // ============================================================
    match /doctors/{doctorId} {
        // Anyone can view a doctor's public profile.
        allow get, list: if true;
        
        // A doctor can create their own profile.
        allow create: if isOwner(doctorId);

        // Admins can update any field.
        // Doctors can update any field EXCEPT isVerified and verificationNote.
        allow update: if isSignedIn() && (
            isAdmin() || 
            (isOwner(doctorId) && !('isVerified' in request.resource.data) && !('verificationNote' in request.resource.data))
        );
    }
    

    // ============================================================
    // /appointments/{appointmentId} (Appointment)
    // ============================================================
    match /appointments/{appointmentId} {

        function isPatientForAppointment(doc) {
            return isSignedIn() && request.auth.uid == doc.patientId;
        }
        
        function isDoctorForAppointment(doc) {
            return isSignedIn() && request.auth.uid == doc.doctorId;
        }

        // CREATE: 
        // - Patients can create for themselves.
        // - If type is virtual, status must be 'Pending', and no time/date/link can be set.
        // - If type is in-person, status must be 'Scheduled' and date/time must be present.
        allow create: if isPatientForAppointment(request.resource.data) || (isDoctor() && request.resource.data.doctorId == request.auth.uid);
        
        // READ: only the involved patient, doctor, or an admin.
        allow get: if isSignedIn() && (
            isOwner(resource.data.patientId) || 
            isOwner(resource.data.doctorId) || 
            isAdmin()
        );

        // UPDATE:
        // - A patient can only cancel ('status' to 'Canceled')
        // - A doctor can update status to 'Completed' or 'Canceled'
        // - A doctor can update a 'Pending' request to 'Scheduled', adding date/time/link
        allow update: if isSignedIn() && (
            isAdmin() ||
            (isOwner(resource.data.patientId) && request.resource.data.status == 'Canceled' && resource.data.status == 'Scheduled') ||
            (isOwner(resource.data.doctorId) && (
                (
                    // Accepting a pending virtual request
                    resource.data.status == 'Pending' &&
                    request.resource.data.status == 'Scheduled' &&
                    request.resource.data.diff(resource.data).affectedKeys().hasAll(['status', 'date', 'time', 'meetLink'])
                ) || 
                (
                    // Rejecting a pending virtual request
                    resource.data.status == 'Pending' &&
                    request.resource.data.status == 'Canceled' &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
                ) ||
                (
                    // Completing or Cancelling a scheduled appointment
                    resource.data.status == 'Scheduled' &&
                    (request.resource.data.status == 'Completed' || request.resource.data.status == 'Canceled') &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
                )
            ))
        );

        // LIST (QUERY): A user can query appointments only if they filter by their OWN patientId or doctorId.
        allow list: if isSignedIn() && (
          (request.query.where.doctorId == request.auth.uid && isDoctor()) ||
          (request.query.where.patientId == request.auth.uid && isPatient()) ||
          isAdmin()
        );

        // Delete: only admins for now.
        allow delete: if isAdmin();
    }
    
    // ============================================================
    // /prescriptions/{prescriptionId} (Prescription)
    // ============================================================
    match /prescriptions/{prescriptionId} {
      // READ: A user can read a single prescription doc if they are the patient or doctor on it.
      allow get: if isSignedIn() && (resource.data.patientId == request.auth.uid || resource.data.doctorId == request.auth.uid || isAdmin());
      
      // LIST (QUERY): A user can query prescriptions only if they filter by their OWN patientId or doctorId.
      // An admin can list all prescriptions.
      allow list: if isSignedIn() && 
        (
          (request.query.where.patientId == request.auth.uid && isPatient()) ||
          (request.query.where.doctorId == request.auth.uid && isDoctor()) ||
          isAdmin()
        );

      // CREATE: A doctor can create a prescription if they are the doctor listed on it.
      allow create: if isSignedIn() && isDoctor() && request.resource.data.doctorId == request.auth.uid;

      // UPDATE/DELETE: Only the prescribing doctor or an admin can modify/delete it.
      allow update, delete: if isSignedIn() && (isOwner(resource.data.doctorId) || isAdmin());
    }


    // ============================================================
    // /vaccinationDrives/{vaccinationDriveId} (public)
    // ============================================================
    match /vaccinationDrives/{vaccinationDriveId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    // ============================================================
    // /vaccinationRegistrations/{registrationId}
    // ============================================================
    match /vaccinationRegistrations/{registrationId} {
        // A user can create their own registration.
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        
        // A user can read their own registration, admins can read any.
        allow get: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin());
        
        // A user can list registrations they own, admins can list all.
        allow list: if isSignedIn() && (request.query.where.userId == request.auth.uid || isAdmin());
        
        // Admins can delete registrations.
        allow delete, update: if isAdmin();
    }


    // ============================================================
    // /healthCamps/{healthCampId} (public)
    // ============================================================
    match /healthCamps/{healthCampId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }
    
    // ============================================================
    // /announcements/{announcementId} (public)
    // ============================================================
    match /announcements/{announcementId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    // ============================================================
    // /forumPosts/{postId} (ForumPost)
    // ============================================================
     match /forumPosts/{postId} {
        // Any signed-in user can create a post.
        allow create: if isSignedIn();

        // Anyone can read posts.
        allow get, list: if true;

        // Allow owner/admin to update/delete.
        allow update: if isSignedIn() &&
          (
            (isOwner(resource.data.authorId) || isAdmin()) ||
            (
              // Allow any signed in user to increment the like count and add their own UID to likedBy
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount', 'likedBy']) &&
              request.resource.data.likeCount == resource.data.likeCount + 1 &&
              request.resource.data.likedBy.hasAll(resource.data.likedBy) &&
              request.resource.data.likedBy.size() == resource.data.likedBy.size() + 1 &&
              request.auth.uid in request.resource.data.likedBy
            ) ||
            (
              // Allow a user to decrement the like count and remove their own UID from likedBy
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeCount', 'likedBy']) &&
              request.resource.data.likeCount == resource.data.likeCount - 1 &&
              !request.resource.data.likedBy.hasAny([request.auth.uid]) &&
              request.auth.uid in resource.data.likedBy
            ) ||
            (
                // Allow anyone to increment viewCount
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']) &&
                request.resource.data.viewCount == resource.data.viewCount + 1
            )
          );
        
        allow delete: if isSignedIn() && (isOwner(resource.data.authorId) || isAdmin());
        
        // --- /forumPosts/{postId}/replies/{replyId} ---
        match /replies/{replyId} {
             // Any signed-in user can create a reply.
            allow create: if isSignedIn();

            // Anyone can read replies.
            allow get, list: if true;

            // Only the author or an admin can update/delete their own reply.
            allow update, delete: if isSignedIn() && (isOwner(resource.data.authorId) || isAdmin());
        }
     }
     
     
    // ============================================================
    // /feedback/{feedbackId} (Feedback)
    // ============================================================
    match /feedback/{feedbackId} {
        // Any signed-in user can create feedback.
        allow create: if isSignedIn();

        // Public can list feedback for testimonials if they query for high ratings and correct type
        allow list: if (
            request.query.where.rating >= 4 &&
            request.query.where.feedbackType == 'General Feedback'
          ) || isAdmin();
        
        // Admins can get, update, or delete any feedback.
        allow get, update, delete: if isAdmin();
    }
  }
}
