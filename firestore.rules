
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAssignedDoctor(patientId) {
      return isSignedIn()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid)/patients/$(patientId));
    }

    function userProfileIdMatchesDocIdOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    function userProfileIdIsImmutableOnUpdate() {
      return !('id' in request.resource.data)
          || request.resource.data.id == resource.data.id;
    }

    function hasCorrectUserIdOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    function userIdIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    // =====================================================================
    // USERS COLLECTION â€” private data
    // =====================================================================

    match /users/{userId} {

      // Get allowed to owner or assigned doctor
      allow get: if isOwner(userId) || isAssignedDoctor(userId);
      allow list: if false;     // prevent user enumeration
      allow create: if isOwner(userId) && userProfileIdMatchesDocIdOnCreate(userId);
      allow update: if isOwner(userId) && userProfileIdIsImmutableOnUpdate();
      allow delete: if isOwner(userId);

      // ============== PATIENTS SUBCOLLECTION ===================
      // Doctor sees their own patient list
      match /patients/{patientId} {
        allow read, list: if isOwner(userId);

        // Owner (doctor) manages list, OR patient adds themselves
        allow write: if isOwner(userId)
                  || (isOwner(patientId) && request.resource.data.patientId == patientId);
      }

      // ============== HEALTH RECORDS ===================
      match /healthRecords/{healthRecordId} {
        allow read, list: if isOwner(userId) || isAssignedDoctor(userId);

        allow create: if (isOwner(userId) || isAssignedDoctor(userId))
                    && hasCorrectUserIdOnCreate(userId);

        allow update, delete: if (isOwner(userId) || isAssignedDoctor(userId))
                           && userIdIsImmutable();
      }

      // ============== NOTIFICATIONS ===================
      match /notifications/{notificationId} {
        allow get, list: if isOwner(userId);

        allow create: if isOwner(userId) && hasCorrectUserIdOnCreate(userId);
        allow update, delete: if isOwner(userId) && userIdIsImmutable();
      }
    }

    // =====================================================================
    // PUBLIC DATA COLLECTIONS
    // =====================================================================

    match /doctors/{doctorId} {
        allow get: if isSignedIn();
        allow write: if false; // Secure by default, only backend/admin should write
    }
    
    // This rule allows any authenticated user to list the documents in the /doctors collection.
    // It is separate from the /doctors/{doctorId} rule which governs access to individual documents.
    match /doctors {
      allow list: if isSignedIn();
    }

    // ============= VACCINATION DRIVES ==================
    match /vaccinationDrives/{driveId} {
      allow read: if true;
      allow write: if false;
    }

    // ============= HEALTH CAMPS ==================
    match /healthCamps/{campId} {
      allow read: if true;
      allow write: if false;
    }

  }
}
