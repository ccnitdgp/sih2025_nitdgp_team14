
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // Helpers
    // ============================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Load current user's profile
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function hasRole(role) {
      return isSignedIn()
        && userDoc(request.auth.uid).data.role == role;
    }

    function isPatient() { return hasRole("patient"); }
    function isDoctor()  { return hasRole("doctor"); }
    function isAdmin()   { return hasRole("admin"); }

    // Is the current doctor linked to this patient via PatientLink?
    function isAssignedDoctorForUser(userId) {
      return isDoctor()
        && exists(
          /databases/$(database)/documents/users/$(request.auth.uid)/patients/$(userId)
        );
    }

    // ============================================================
    // /users/{userId}  (UserProfile - private)
    // ============================================================

    match /users/{userId} {

      // Create own profile: id field must match auth.uid & path.
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.id == userId;

      // User reads/updates their own profile.
      allow get, update: if isOwner(userId);

      // Only admins can list or delete user profiles.
      allow list, delete: if isAdmin();


      // ----------------------------------------------
      // /users/{userId}/healthRecords/{healthRecordId}
      // ----------------------------------------------
      match /healthRecords/{healthRecordId} {

        // For new docs, userId field must match path.
        function newRecordUserMatchesPath() {
          return request.resource.data.userId == userId;
        }

        // For existing docs, userId field must match path.
        function existingRecordUserMatchesPath() {
          return resource.data.userId == userId;
        }

        // Create: patient themself, assigned doctor, or admin.
        allow create: if isSignedIn()
          && newRecordUserMatchesPath()
          && (
            isOwner(userId) ||
            isAssignedDoctorForUser(userId) ||
            isAdmin()
          );

        // Read/list/update/delete:
        // - patient owner
        // - assigned doctor (via PatientLink)
        // - admin
        allow get, list, update, delete: if isSignedIn()
          && existingRecordUserMatchesPath()
          && (
            isOwner(userId) ||
            isAssignedDoctorForUser(userId) ||
            isAdmin()
          );
      }


      // ----------------------------------------------
      // /users/{userId}/notifications/{notificationId}
      // ----------------------------------------------
      match /notifications/{notificationId} {

        // Only the owner (or admin) can manage their notifications.
        allow create, get, list, update, delete: if isSignedIn()
          && (isOwner(userId) || isAdmin());
      }


      // ----------------------------------------------
      // /users/{doctorId}/patients/{patientId} (PatientLink)
      // ----------------------------------------------
      match /patients/{patientId} {

        // Only the doctor who owns this /users/{doctorId} doc
        // or an admin can manage these links.
        allow create, get, list, update, delete: if isSignedIn()
          && (
            (isOwner(userId) && isDoctor()) ||
            isAdmin()
          );
      }
    }


    // =400;0,700;1,400;1,700&display=swap" rel="stylesheet" />
      </head>
      <body className="font-body antialiased">
        <ThemeProvider
          attribute="class"
          defaultTheme="light"
          disableTransitionOnChange
        >
          <FirebaseClientProvider>
            <div className="flex flex-col min-h-screen">
              <Header />
              <main className="flex-grow">{children}</main>
              <Footer />
            </div>
            <Toaster />
          </FirebaseClientProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}

    